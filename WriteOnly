#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#define H 30

typedef struct comando{
    long int p1;
    long int p2;
    char par;
}cmd;

char ** Create2D(ssize_t Strings)
{
    int i;
    char **a = {0};
    a = calloc(Strings, sizeof(char *));
    for(i=0;i<Strings; i++)
    {
        a[i] = calloc(1024, 1);
    }
    return a;
}

char ** Reallocation2D(char ** a, size_t dim){
    int i;
    char **b = {0};
    b = calloc(dim*2, sizeof(char *));
    for(i=0;i<dim*2; i++)
    {
        b[i] = calloc(1024, 1);
    }
    for(i=0;i<dim;i++){
        strcpy(b[i],a[i]);
    }

    for(i=0;i<dim; i++)
    {
        if(a[i]) free(a[i]);
    }

    free(a);

    return b;
}

void free2D(char ** a, ssize_t numStrings)
{
    int i;
    for(i=0;i<numStrings; i++)
    {
        if(a[i]) free(a[i]);
    }
    free(a);
}

void change(cmd comando, char **array, FILE *fp){
    size_t bufsize = 1024;
    char *buffer;
    buffer = (char *) malloc(bufsize * sizeof(char));
    long int i=comando.p1, k=comando.p2;
    //printf("change da %d a %d\n", comando.p1,comando.p2);
    char eof[2]="q";

    while(i<=k){
        getline(&buffer, &bufsize, fp);
        if (strcmp(buffer,eof)==0) break;
        strcpy(array[i], buffer);
        i++;
    }

}
void undo(cmd comando){
    //printf("undo da %d\n", comando.p1);
}
void redo(cmd comando){
    //printf("redo da %d\n", comando.p1);
}


void print(cmd comando,char** array){
    long int i=comando.p1, k=comando.p2;
    //printf("print da %d a %d\n", comando.p1, comando.p2);
    while(i<=k){
        if (i==0) {
            printf(".\n");
            i++;
            continue;
        }
        printf("%s", array[i]);
        i++;
    }
}

cmd GetOrder(FILE *fp){
    size_t bufsize = 1024;
    char *buffer=NULL;
    char *string;
    cmd istr;

    getline(&buffer, &bufsize, fp);
    string = malloc(strlen(buffer)*sizeof(char) + 1);
    strcpy(string, buffer);
    free(buffer);
    int i=0,j=0,k=0;
    char value1[5],value2[5];

    while(1) {
        if (string[k] == 'c' || string[k] == 'p' || string[k] == 'r' || string[k] == 'u' || string[k] == 'd' ||
            string[k] == '.' || string[k] == 'q') {
            istr.par = string[k];
            break;
        }
        k++;
    }

    if (istr.par=='.'||istr.par=='q') return istr;


    if (istr.par == 'u'){
        istr.p1=atoi(&string[0]);
        istr.par=string[1];
    }
    else if (istr.par =='r') {
        istr.p1=atoi(&string[0]);
        istr.par=string[1];
    }
    else {
        while(1){
            if (string[i]==',') break;
            value1[i]=string[i];
            i++;
        }
        value1[i]='\0';

        while (string[i]!=istr.par){
            i++;
            if (string[i]==istr.par) break;
            value2[j]=string[i];
            j++;
        }
        value2[j]='\0';

        istr.p1=atoi(value1);
        istr.p2=atoi(value2);
    }
    return istr;
}


void interpreter(cmd comando,char* ar, FILE *fp){

    if (comando.par=='c')
        change(comando,ar,fp);
    else if (comando.par=='u')
        undo(comando);
    else if (comando.par=='r')
        redo(comando);
    else if (comando.par=='p')
        print(comando,ar);

}


int main() {
    FILE *fp;
    cmd istruzione;
    int i;

    char **Array = {0};
    Array = Create2D(H);

    fp=fopen("prova.txt", "rt");
    int dim=30;


    while(1){
        istruzione=GetOrder(fp);
        if (dim<istruzione.p2+1) {
            Array = Reallocation2D(Array,dim);
            dim=dim*2;
        }
        interpreter(istruzione,Array, fp);
        if (istruzione.par=='q') {
            break;
        }
    }

    free2D(Array, dim);

    return 0;
}
