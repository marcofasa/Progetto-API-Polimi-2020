#include <stdlib.h>
#include <stdio.h>
#include <string.h>
typedef struct comando{
    long int p1;
    long int p2;
    char par;
}cmd;

typedef struct Stack {
    int top;
    cmd instr;
    struct Stack *next;
} Stack;

struct uStack *top=NULL;

void push(cmd istr)
{
    struct Stack *newptr = malloc(sizeof(struct Stack));
    newptr->instr = istr;
    newptr->next = top;
    top = newptr;
}

cmd pop(Stack node)
{
    if (top != NULL)
    {
        //node.next;
        return node.instr;
    }

}



char ** Create2D(ssize_t Strings)
{
    int i;
    char **a = {0};
    a = calloc(Strings, sizeof(char *));

    for(i=0;i<Strings; i++)
    {
        a[i]=NULL;
        a[i] = calloc(1024 , sizeof(char));

    }
    return a;
}

char ** Reallocation2D(char ** a, size_t dim, size_t molt){
    int i;
    char **b = {0};
    b = calloc(dim*molt+1, sizeof(char *));

    for (i=0; i<dim*molt+1; i++){
        b[i]=NULL;

    }

    for(i=0;i<dim;i++){
        b[i]=a[i];
    }

    for (i=dim; i<dim*molt+1; i++){
        b[i] = calloc(1024, sizeof(char));
    }

    free(a);

    return b;
}

void change(cmd comando, char **array, FILE *fp){
    size_t bufsize = 1024;
    char *buffer, * string;
    buffer = (char *) malloc(1024);
    long int i=comando.p1, k=comando.p2;
    string = malloc(1024*sizeof(char));

    while(i<=k){
        fgets(string,bufsize, fp);
        strcpy(array[i],string);
        i++;
    }

}
void undo(cmd comando){
    //printf("undo da %d\n", comando.p1);
}
void redo(cmd comando){
    //printf("redo da %d\n", comando.p1);
}


void print(cmd comando,char **array){
    long int i=comando.p1, k=comando.p2;
    //printf("%x\n", array+1);
    //printf("%d", array[0]);
    //printf("print da %d a %d\n", comando.p1, comando.p2);
    while(i<=k){
        if (!*array[i]) printf(".\n");
        printf("%s", array[i]);
        i++;
    }
}

void delete(cmd comando,char **array, int dim){
    long int i=comando.p1, k=comando.p2;
    int j=1,t=1;
    int o=k, u=i,eof=1;

    if(i==0) i++;

        while(i<=o){
            if (!*array[o]) k--;
            o--;
        }

        if (i==k && (!*array[i])) eof=0;

        while(dim>(k+j)){
            if(eof==0)break;
            memmove(array[i],array[k+j],1024);
            i++;
            j++;

        }

        j=dim-((o-i)+1);

        while(j<dim)
        {
            if(eof==0)break;
            array[j]=NULL;
            j++;
        }

}

cmd GetOrder(FILE *fp){
    size_t bufsize = 1024;
    char *buffer=NULL;
    char *string;
    cmd istr;
    string = malloc(1024);
    fgets(string,bufsize, fp);

    int i=0,j=0,k=0;
    char value1[50],value2[50];

    while(1) {
        if (string[k] == 'c' || string[k] == 'p' || string[k] == 'r' || string[k] == 'u' || string[k] == 'd' ||
            string[k] == '.' || string[k] == 'q') {
            istr.par = string[k];
            break;
        }
        k++;
    }

    if (istr.par=='.'||istr.par=='q') return istr;


    if (istr.par == 'u'){
        istr.p1=atoi(&string[0]);
        istr.par=string[1];
    }
    else if (istr.par =='r') {
        istr.p1=atoi(&string[0]);
        istr.par=string[1];
    }
    else {
        while(1){
            if (string[i]==',') break;
            value1[i]=string[i];
            i++;
        }
        value1[i]='\0';

        while (string[i]!=istr.par){
            i++;
            if (string[i]==istr.par) break;
            value2[j]=string[i];
            j++;
        }
        value2[j]='\0';

        istr.p1=atoi(value1);
        istr.p2=atoi(value2);
    }
    return istr;
}


void interpreter(cmd comando,char** ar, FILE *fp,int dim){

    if (comando.par=='c')
        change(comando,ar,fp);
    else if (comando.par=='u')
        undo(comando);
    else if (comando.par=='r')
        redo(comando);
    else if (comando.par=='p')
        print(comando,ar);
    else if (comando.par=='d')
        delete(comando,ar,dim);

}


int main() {
    FILE *fp;
    cmd istruzione;
    int dim = 5;
    char **Array = {0};
    Array = Create2D(dim);

    fp = stdin;


    while (1) {
        int molt = 0;
        istruzione = GetOrder(fp);
        if (istruzione.par == 'q') {
            break;
        }
        molt = ((istruzione.p2 + (istruzione.p2-istruzione.p1)) / dim) + 1;
        if (dim <= istruzione.p2 + (istruzione.p2-istruzione.p1)) {
            Array = Reallocation2D(Array, dim, molt);
            dim = dim * molt;
        }
        interpreter(istruzione, Array, fp,dim);
    }

    free(Array);

    return 0;
}
